{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\scripts\\sdk/assets\\scripts\\sdk\\Gif.js"],"names":["WeiShuSdk","require","PlatformMgr","cc","Class","extends","Component","properties","btn","Button","app","Label","listCfg","display","autoRef","seqSlot","bog","swTimes","anim","Animation","playTimes","enableDisplay","cfg","node","opacity","onLoad","userData","vidStamp","getTimeSpanAt0","idx","processCfg","on","onNav","onDisable","off","chkAutoRef","onEnable","url","baseUrl","self","loader","load","err","res","data","regBoards","len","length","Math","random","fetchAd","mod","getAnimationState","raw","playNext","urls","i","count","push","spfs","j","sp","SpriteFrame","clip","AnimationClip","createWithSpriteFrames","interval","name","speed","addClip","split","scheduleOnce","play","string","currentClip","wx","navigateToMiniProgram","appId","appid","path","success","console","log","adStatis","fail","unschedule"],"mappings":"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","file":"Gif.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\sdk","sourcesContent":["var WeiShuSdk = require(\"WeiShuSdk\");\r\nconst PlatformMgr = require('PlatformMgr');\r\ncc.Class({\r\n    extends: cc.Component,\r\n    properties: {\r\n        btn: cc.Button,\r\n        app: cc.Label,\r\n        listCfg: [],\r\n        display: false, //是否显示自身\r\n        autoRef: false, //是否自动刷新动图\r\n        seqSlot: true, //是否顺序播放动图\r\n        bog: 5, //单图自动刷新间隔/秒\r\n        swTimes:2, //如果自动刷新 播放几次后自动刷新\r\n        anim: cc.Animation, //动画组件\r\n        playTimes: 0 //单动画播放次数\r\n    },\r\n\r\n    enableDisplay() {\r\n        if(this.cfg){\r\n            this.node.opacity = 255;\r\n        }else{\r\n            this.display = true;\r\n        }\r\n    },\r\n\r\n    onLoad () {\r\n        this.node.opacity = 0;\r\n        if(WeiShuSdk.userData.vidStamp && (WeiShuSdk.getTimeSpanAt0() < WeiShuSdk.userData.vidStamp)){\r\n            return; //今天已看过视频广告 广告组件已关闭\r\n        }\r\n        this.idx = -1;\r\n        this.processCfg();\r\n        \r\n        this.btn.node.on(\"click\", this.onNav, this);\r\n    },\r\n\r\n    onDisable() {\r\n        this.btn.node.off(\"click\", this.onNav, this);\r\n        this.autoRef &&  this.anim.off(\"stop\", this.chkAutoRef, this);\r\n    },\r\n\r\n    onEnable(){\r\n        this.btn.node.on(\"click\", this.onNav, this);\r\n        this.autoRef &&  this.anim.on(\"stop\", this.chkAutoRef, this);\r\n    },\r\n\r\n    processCfg() {\r\n        let url = WeiShuSdk.baseUrl + \"Gif2End/knife666_gif.json\";\r\n        this.listCfg = [];\r\n        let self = this;\r\n        cc.loader.load( url, function( err, res) {\r\n            if (res && res.data){\r\n                (self.listCfg = res.data);\r\n                self.autoRef = !!res.autoRef;\r\n                self.seqSlot = !!res.seqSlot; //是否顺序播放 否则随机播放\r\n                self.bog = res.bog;\r\n                self.swTimes = res.swTimes;\r\n                self.playTimes = 0;\r\n                self.regBoards();\r\n                self.anim.on(\"stop\", self.chkAutoRef, self); //播放完成检查自动刷新\r\n            }\r\n        });\r\n    },\r\n\r\n    regBoards() { //注册新动图\r\n        if(!this.listCfg) return;\r\n        let len = this.listCfg.length;\r\n        if(this.seqSlot){ //顺序播放\r\n            this.idx = (this.idx >= len - 1) ? 0 : (this.idx + 1);\r\n        }else{ //随机播放\r\n            this.idx = Math.random() * len|0;\r\n        }\r\n        let res = this.listCfg[this.idx];\r\n        if(!res) return;\r\n        this.fetchAd(res);\r\n    },\r\n\r\n    fetchAd(cfg){ //拉取动图广告\r\n        if(cfg.mod == 1){ //序列帧动画\r\n            if(this.anim.getAnimationState(cfg.raw)){\r\n                this.playNext(cfg, cfg.raw);\r\n                return;\r\n            }\r\n            let urls = [];\r\n            for(let i=1;i<cfg.count;i++) {\r\n                urls.push(WeiShuSdk.baseUrl + \"Gif2End/anim/\" + cfg.raw +\"/\" + i + \".png\");\r\n            }\r\n            let self = this;\r\n            cc.loader.load(urls, function( err, res) {\r\n                let spfs = [];\r\n                for(let j=0; j<cfg.count-1; j++){\r\n                    let sp = new cc.SpriteFrame(urls[j]);\r\n                    spfs.push(sp);\r\n                }\r\n                let clip = cc.AnimationClip.createWithSpriteFrames(spfs, cfg.interval);\r\n                clip.name = cfg.raw;\r\n                clip.speed = 1;\r\n                self.anim.addClip(clip);\r\n                self.playNext(cfg, cfg.raw);\r\n            });\r\n        }else{ //单图\r\n            let name = cfg.raw.split('.')[0];\r\n            if(this.anim.getAnimationState(name)){\r\n                this.playNext(cfg, name);\r\n                (this.autoRef) && this.scheduleOnce(this.regBoards, this.bog);\r\n                return;\r\n            }\r\n            let url = WeiShuSdk.baseUrl + \"Gif2End/img/\" + cfg.raw;\r\n            let sp = new cc.SpriteFrame(url);\r\n            let clip = cc.AnimationClip.createWithSpriteFrames([sp]); \r\n            clip.name = name;\r\n            clip.speed = 1;\r\n            this.anim.addClip(clip);\r\n            this.playNext(cfg, name);\r\n            (this.autoRef) && this.scheduleOnce(this.regBoards, this.bog);\r\n        }\r\n    },\r\n\r\n    playNext(cfg, name){ //播放下一个动图\r\n        this.anim.play(name);\r\n        this.cfg = cfg;\r\n        this.app.string = cfg.name;\r\n        this.display && (this.node.opacity = 255);\r\n    },\r\n\r\n    chkAutoRef(){\r\n        if(this.autoRef){ \r\n            this.playTimes += 1;\r\n            if(this.cfg.mod == 1){\r\n                if(this.playTimes < this.swTimes){\r\n                    this.anim.play(this.anim.currentClip.name)\r\n                }else{\r\n                    this.playTimes = 0;\r\n                    this.regBoards();\r\n                }\r\n            }\r\n        }else{\r\n            this.anim.play(this.anim.currentClip.name)\r\n        }\r\n    },\r\n\r\n    onNav() { //跳转到小游戏\r\n        let self = this;\r\n        if(!this.cfg) return;\r\n        if (wx.navigateToMiniProgram){\r\n            wx.navigateToMiniProgram({\r\n                appId: self.cfg.appid,\r\n                path: self.cfg.path,\r\n                success: res=>{\r\n                    console.log(\"nav successed\");\r\n                    PlatformMgr.adStatis(self.cfg);\r\n                },\r\n                fail: res=>{\r\n                    self.unschedule(self.regBoards);\r\n                    self.playTimes = 0;\r\n                    self.regBoards(); //刷新动图\r\n                }\r\n            });\r\n        }\r\n    }\r\n});\r\n"]}