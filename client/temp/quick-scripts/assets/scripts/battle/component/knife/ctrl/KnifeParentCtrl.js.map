{"version":3,"sources":["KnifeParentCtrl.js"],"names":["KnifeMomentState","require","cc","Class","extends","Component","properties","init","itemNode","node","on","isDanceRelease","knifeMomentStateComp","getComponent","knifeOwnerComp","updateLogic","dt","isDirty","state","Release","childWorldPos","parent","convertToWorldSpaceAR","position","childPos","convertToNodeSpaceAR","parentWorldPos","parentPos","dir","sub","arr","Math","PI","index","floor","random","rotateOffset","rotateDir","mul","throwDir","rotate","newPos","add","emit","changeParent","owner","newParent","console","error","log","worldPos"],"mappings":"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","file":"KnifeParentCtrl.js","sourceRoot":"..\\..\\..\\..\\..\\..\\..\\..\\assets\\scripts\\battle\\component\\knife\\ctrl","sourcesContent":["/**\r\n * @fileoverview 刀的父节点控制\r\n * @author zhangzhuang@gameley.cn (张庄)\r\n */\r\n\r\nconst KnifeMomentState = require('Types').KnifeMomentState;\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n\r\n\r\n    },\r\n\r\n\r\n    init: function (itemNode) {\r\n        this.itemNode = itemNode;\r\n        this.node.on('isDanceRelease', (isDanceRelease) => {\r\n            this.isDanceRelease = isDanceRelease;\r\n        }, this)\r\n        this.knifeMomentStateComp = this.node.getComponent('KnifeMomentStateComponent');\r\n        this.knifeOwnerComp = this.node.getComponent('KnifeOwnerComponent');\r\n    },\r\n\r\n\r\n    updateLogic: function (dt) {\r\n        if (!this.knifeMomentStateComp) this.knifeMomentStateComp = this.node.getComponent('KnifeMomentStateComponent');\r\n        if (!this.knifeOwnerComp) this.knifeOwnerComp = this.node.getComponent('KnifeOwnerComponent');\r\n\r\n        //根据组件的状态做逻辑处理\r\n        if (this.knifeMomentStateComp.isDirty) {\r\n            switch (this.knifeMomentStateComp.state) {\r\n                case KnifeMomentState.Release:\r\n                    var childWorldPos = this.node.parent.convertToWorldSpaceAR(this.node.position);\r\n                    var childPos = this.itemNode.convertToNodeSpaceAR(childWorldPos);\r\n                    var parentWorldPos = this.node.parent.parent.convertToWorldSpaceAR(this.node.parent.position);\r\n                    var parentPos = this.itemNode.convertToNodeSpaceAR(parentWorldPos);\r\n\r\n                    var dir = childPos.sub(parentPos);\r\n                    var arr = [Math.PI / 2, -Math.PI / 2];\r\n                    var index = Math.floor(Math.random() * 2)\r\n                    var rotateOffset = Math.PI / 36 - Math.random() * (Math.PI / 18); //-5~5度的方向偏移\r\n                    var rotateDir = arr[index] + rotateOffset;\r\n                    if (this.isDanceRelease === true) {\r\n                        rotateDir = -Math.PI / 2;\r\n                    }\r\n                    var mul = Math.random() + 2; //2~3倍切线距离\r\n                    var throwDir = dir.rotate(rotateDir).mul(mul); //获得圆的切线向量\r\n\r\n                    var newPos = throwDir.add(childPos);\r\n\r\n\r\n                    this.node.emit('releasePosition', newPos);\r\n                    this.changeParent(this.itemNode);\r\n                    break;\r\n            }\r\n        }\r\n\r\n\r\n        if (this.knifeOwnerComp.isDirty) {\r\n            this.changeParent(this.knifeOwnerComp.owner);\r\n        }\r\n    },\r\n\r\n\r\n    changeParent: function (newParent) {\r\n        if (!newParent) {\r\n            console.error('Knife changeParent newParent is null');\r\n            return\r\n        }\r\n        if (newParent === this.node.parent) {\r\n            console.log('同一个父节点，无需更换');\r\n            return\r\n        }\r\n        var worldPos = this.node.parent.convertToWorldSpaceAR(this.node.position);\r\n        var newPos = newParent.convertToNodeSpaceAR(worldPos);\r\n        this.node.parent = newParent;\r\n        this.node.position = newPos;\r\n    },\r\n\r\n\r\n\r\n});"]}