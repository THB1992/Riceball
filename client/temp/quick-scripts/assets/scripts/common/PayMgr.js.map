{"version":3,"sources":["PayMgr.js"],"names":["PlatformType","require","PlatformMgr","PlayerData","ConfigData","PayMgr","cc","Class","statics","instance","init","_global","window","global","cleanUp","_closeCallback","_errCallback","result","setTimeout","hawkeye_report_purchase","_price","_payIndex","console","log","_isSupportPurchase","priceString","_priceString","_queryProductsCallback","updateVipWithoutInterstitial","_restoreCallback","properties","_isPaying","setIsPaying","isNot","getIsPaying","setUiMgr","uiMgr","requestProductPrices","queryProductsCallback","platformType","WECHAT","IOS","jsb","reflection","callStaticMethod","ANDROID","restoreProducts","callback","payByIndex","payIndex","closeCallback","errCallback","finalCloseCallback","success","performance","now","director","_lastUpdate","getShopDataPriceByIndex"],"mappings":"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","file":"PayMgr.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\common","sourcesContent":["const PlatformType = require('Types').PlatformType;\nconst PlatformMgr = require('PlatformMgr');\nconst PlayerData = require('PlayerData');\nconst ConfigData = require('ConfigData');\n\nconst PayMgr = cc.Class({\n    statics: {\n        instance: null,\n        init: function () {\n            if (PayMgr.instance === null) {\n                PayMgr.instance = new PayMgr();\n                PayMgr.instance.init();\n            }\n            var _global = typeof window === 'undefined' ? global : window;\n            _global.PayMgr = PayMgr;\n        },\n        cleanUp: function () {\n            PayMgr.instance = null;\n        },\n\n        _closeCallback: null,\n\n        _errCallback: null,\n\n        _errCallback: null,\n\n        _queryProductsCallback: null,\n\n        _restoreCallback: null,\n\n        _priceString: \"\",\n\n        _isSupportPurchase: true,\n\n\n        normalPayCallBack: function (result) {     \n       \n            if (result) {\n                // 下发游戏奖励\n                PayMgr._closeCallback(true);\n\n                setTimeout(() => {\n                    PlatformMgr.hawkeye_report_purchase(PayMgr._price ,PayMgr._payIndex);\n                }, 200)\n            } else {\n                PayMgr._closeCallback(false);\n            }\n        },\n\n        errorPayCallBack: function () {\n            console.log('errorPayCallBack=================');\n            PayMgr._isSupportPurchase = false;\n            if(PayMgr._errCallback){\n                PayMgr._errCallback();\n            }\n        },\n\n        queryProductsCallBack: function (priceString) {\n            PayMgr._priceString = priceString;\n            // console.log('queryProductsCallBack priceString=========='+ priceString);\n            if (PayMgr._queryProductsCallback) {\n                PayMgr._queryProductsCallback(priceString);\n            }\n        },\n\n        restoreCallBack: function (result) {\n            if (result) {\n                PlayerData.instance.updateVipWithoutInterstitial()\n                if (PayMgr._restoreCallback){\n                    PayMgr._restoreCallback();\n                }\n            }\n        },\n    },\n\n    properties: {\n        _isPaying: false,\n    },\n\n    init: function () {\n\n    },\n\n    setIsPaying: function (isNot) {\n        this._isPaying = isNot;\n    },\n\n    getIsPaying: function () {\n        return this._isPaying;\n    },\n\n    setUiMgr: function (uiMgr) {\n        this.uiMgr = uiMgr;\n    },\n\n    requestProductPrices: function (queryProductsCallback) {\n        PayMgr._queryProductsCallback = queryProductsCallback;\n\n        if (PayMgr._priceString != '') {\n            if (queryProductsCallback) {\n                queryProductsCallback(PayMgr._priceString);\n                return;\n            }\n        }\n\n        switch (PlatformMgr.platformType) {\n            case PlatformType.WECHAT: {\n                break;\n            }\n\n            case PlatformType.IOS:\n                {\n                    jsb.reflection.callStaticMethod(\"IAPHelper\", \"requestProducts\");\n                }\n                break;\n            case PlatformType.ANDROID:\n                {\n                    jsb.reflection.callStaticMethod(\n                        \"org/cocos2dx/javascript/activity/IABManager\",\n                        \"requestProducts\",\n                        \"()V\"\n                    );\n                }\n                break;\n            default: {\n                PayMgr._queryProductsCallback('price#PHP 105.00#PHP 410.00#PHP 775.00#PHP 1,550.00#PHP 2,850.00');\n                break;\n            }\n        }\n\n    },\n\n\n    restoreProducts: function(callback) {\n        PayMgr._restoreCallback = callback;\n        if (PlatformMgr.platformType === PlatformType.IOS) {\n            jsb.reflection.callStaticMethod(\"IAPHelper\", \"restoreCompletedTransactions\");\n        }\n    },\n\n    payByIndex: function (payIndex, closeCallback, errCallback) {\n\n        let finalCloseCallback = (success) => {\n            setTimeout(() => {\n                if (performance && performance.now) {\n                    cc.director._lastUpdate = performance.now();\n                }\n                closeCallback(success)\n            }, 100);\n        }\n\n        PayMgr._closeCallback = finalCloseCallback;\n        PayMgr._errCallback = errCallback;\n        PayMgr._payIndex = payIndex;\n        PayMgr._price = ConfigData.instance.getShopDataPriceByIndex(payIndex);\n\n        if (!PayMgr._isSupportPurchase) {\n            if (errCallback) {\n                errCallback();\n            }\n\n            return;\n        }\n\n        switch (PlatformMgr.platformType) {\n            case PlatformType.WECHAT: {\n                break;\n            }\n\n            case PlatformType.IOS:\n                {         \n                    jsb.reflection.callStaticMethod(\"IAPHelper\", \"buyProductByPayIndex:\", payIndex);\n                    break;\n                }\n\n            case PlatformType.ANDROID:\n                {\n                    jsb.reflection.callStaticMethod(\n                        \"org/cocos2dx/javascript/activity/IABManager\",\n                        \"buyProductByPayIndex\",\n                        \"(I)V\",\n                        payIndex\n                    );\n                }\n                break;\n            default: {\n                finalCloseCallback(true);\n                break;\n            }\n        }\n    },\n\n});"]}